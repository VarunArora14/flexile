#!/bin/bash

set -e

if [ -f ".vercel/project.json" ]; then
    #pnpx vercel env pull .env
    echo "Vercel pull temporarily disabled until env vars are updated"
elif [ ! -f ".env" ]; then
    echo ".env file not found. Please run bin/setup first."
    exit 1
fi

# Install Node.js dependencies first (before generating certificates)
echo "Installing Node.js dependencies..."
pnpm install

# Start local Docker services
echo "Starting Docker services..."
make local

# Prepare backend dependencies and database
echo "Installing backend dependencies..."
cd backend

bundle install

echo "Preparing database..."
bin/rails db:prepare

cd ..

function kill_process_listening_on_port {
  pids="$(lsof -t -i :"$1" -sTCP:LISTEN 2>/dev/null | tr '\n' ' ')"
  if [ -n "$pids" ]; then
    kill -9 $pids 2>/dev/null || true
  fi
}

echo "Cleaning up existing processes..."
kill_process_listening_on_port 3000
kill_process_listening_on_port 3001
kill_process_listening_on_port 8288 # inngest
rm -f backend/tmp/pids/server.pid

echo "Starting application services..."
foreman start -f Procfile.dev "$@"
